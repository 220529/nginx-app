# nginx-app - 架构设计

> **最后更新**: 2025-12-01

## 架构职责

API 网关 + SSL 终止 + 反向代理

## 核心功能

### 1. 域名路由

```nginx
# 核心配置
server {
    listen 80;
    server_name erp.lytt.fun;
    
    # HTTPS 重定向
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl;
    server_name erp.lytt.fun;
    
    # SSL 证书
    ssl_certificate /etc/letsencrypt/live/erp.lytt.fun/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/erp.lytt.fun/privkey.pem;
    
    # 代理到 erp-web
    location / {
        proxy_pass http://erp-web:80;
    }
}
```

### 2. SSL 证书管理

- **提供商**: Let's Encrypt
- **有效期**: 90天
- **续期**: 自动 (cron: `0 2 * * 0`)

### 3. 网络拓扑

```
Internet (80/443)
    ↓
nginx-gateway (nginx-network)
    ↓
erp-web (erp-db-network)
```

## 运维脚本

| 脚本 | 用途 |
|------|------|
| `init-ssl.sh` | 首次申请证书 |
| `renew-ssl.sh` | 证书续期 |
| `start.sh` | 启动服务 |
| `stop.sh` | 停止服务 |
| `restart.sh` | 重启所有服务 |

## 性能配置

```nginx
# Gzip 压缩
gzip on;
gzip_types text/css application/javascript application/json;

# 缓存静态资源
location ~* \.(jpg|jpeg|png|gif|css|js)$ {
    expires 30d;
}

# Keepalive
keepalive_timeout 65;
```

## 运维脚本

| 脚本 | 用途 |
|------|------|
| `init-ssl.sh` | 首次申请证书 |
| `renew-ssl.sh` | 证书续期 |
| `start.sh` | 启动服务 |
| `stop.sh` | 停止服务 |
| `restart.sh` | 重启所有服务 |

---

## 转发规则

| 域名 | 转发目标 | 说明 |
|------|----------|------|
| `erp.lytt.fun` | `http://erp-web:80` | ERP 前端系统 |
| `lego.api.lytt.fun` | `http://47.93.17.251:9005` | Lego API |
| `lego.lytt.fun` | `http://47.93.17.251:9004` | Lego 前端 |
| `nest.lytt.fun` | `http://47.93.17.251:16800` | Nest 服务 |

### 添加新域名

编辑 `conf.d/nginx.conf`:

```nginx
server {
    listen 80;
    server_name new-domain.lytt.fun;
    
    location / {
        proxy_pass http://service-name:port;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

重启服务:
```bash
docker compose -f docker-compose-prod.yml restart
```
