# Nginx Gateway 架构说明

## 角色定位

nginx-app 是整个 ERP 系统的**统一入口网关**，负责根据域名将请求转发到对应的后端服务。

## 架构图

```
                        互联网
                           │
                           ▼
                   47.93.17.251:80
                           │
                           ▼
              ┌────────────────────────┐
              │     nginx-gateway      │
              │      (本服务)           │
              └────────────────────────┘
                           │
      ┌────────────────────┼────────────────────┬──────────────────┐
      │                    │                    │                  │
      ▼                    ▼                    ▼                  ▼
erp.lytt.fun        lego.api.lytt.fun    lego.lytt.fun      nest.lytt.fun
      │                    │                    │                  │
      ▼                    ▼                    ▼                  ▼
  erp-web:80           :9005               :9004              :16800
```

## 网络配置

本服务同时连接两个 Docker 网络：

| 网络 | 用途 |
|------|------|
| `nginx-network` | 本服务自己的网络 |
| `erp-db-network` | ERP 系统共享网络，可访问 erp-web、erp-core 等容器 |

## 转发规则

| 域名 | 转发目标 | 说明 |
|------|----------|------|
| `erp.lytt.fun` | `http://erp-web:80` | ERP 前端系统 |
| `lego.api.lytt.fun` | `http://47.93.17.251:9005` | Lego API |
| `lego.lytt.fun` | `http://47.93.17.251:9004` | Lego 前端 |
| `nest.lytt.fun` | `http://47.93.17.251:16800` | Nest 服务 |

## 文件结构

```
nginx-app/
├── docker-compose-prod.yml   # 生产环境 Docker 配置
├── nginx.conf                # Nginx 主配置 (gzip、日志等)
├── conf.d/
│   └── nginx.conf            # 虚拟主机配置 (转发规则)
└── ARCHITECTURE.md           # 本文档
```

## 部署命令

```bash
cd /app/nginx-app
docker compose -f docker-compose-prod.yml up -d
```

## 依赖关系

本服务依赖 `erp-db-network` 网络，该网络由 `db-app` 创建。

**部署顺序**：`db-app` → `erp-core` → `erp-web` → `nginx-app`

## 添加新服务

如需添加新的域名转发，编辑 `conf.d/nginx.conf`：

```nginx
server {
    listen       80;
    server_name  your-domain.lytt.fun;

    location / {
        proxy_pass  http://your-service:port;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

然后重启服务：

```bash
docker compose -f docker-compose-prod.yml restart
```
