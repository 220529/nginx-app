name: Deploy nginx-gateway

# 触发条件: 推送 tag 或手动触发
on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. 检出代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. 上传配置文件到服务器
      - name: Upload files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          source: "docker-compose-prod.yml,nginx.conf,conf.d"
          target: /app/nginx-app/

      # 3. SSH 到服务器部署
      - name: Deploy on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            cd /app/nginx-app

            # 重建容器以应用新的 volume 挂载和配置
            docker compose -f docker-compose-prod.yml up -d --force-recreate

            # 查看状态
            docker compose -f docker-compose-prod.yml ps

            echo "✅ nginx-gateway 部署完成!"
