name: Deploy nginx-gateway

# 触发条件: 推送到 master 分支或手动触发
on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. 检出代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. 上传配置文件到服务器
      - name: Upload files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          source: "docker-compose-prod.yml,nginx.conf,conf.d"
          target: /app/nginx-app/

      # 3. SSH 到服务器部署
      - name: Deploy on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            cd /app/nginx-app

            # 重新加载配置（不中断服务）
            docker compose -f docker-compose-prod.yml exec -T nginx nginx -s reload || \
            docker compose -f docker-compose-prod.yml up -d

            # 查看状态
            docker compose -f docker-compose-prod.yml ps

            echo "✅ nginx-gateway 部署完成!"
